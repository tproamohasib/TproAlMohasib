<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام TPRO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <style>
        .stats-card {
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
    </style>
    <script>
        // التحقق من تسجيل الدخول فورًا عند تحميل الصفحة
        (function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'login.html';
            }
        })();
    </script>
</head>
<body>
    <!-- شريط التنقل -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">لوحة التحكم TPRO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard">الرئيسية</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#customers">العملاء</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#messages">الرسائل</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#version">تحديث رقم الإصدار</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#changePassword">تغيير كلمة المرور</a>
                    </li>
                </ul>
                <button id="logoutBtn" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    تسجيل الخروج
                </button>
            </div>
        </div>
    </nav>

    <!-- لوحة الإحصائيات -->
    <section id="dashboard" class="py-5">
        <div class="container">
            <h2 class="mb-4">الإحصائيات</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card stats-card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <h3 id="totalCustomers">0</h3>
                            <p class="mb-0">إجمالي العملاء</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-download fa-3x mb-3"></i>
                            <h3 id="todayDownloads">0</h3>
                            <p class="mb-0">تحميلات اليوم</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <h3 id="monthlyDownloads">0</h3>
                            <p class="mb-0">تحميلات الشهر</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- قائمة العملاء -->
    <section id="customers" class="py-5 bg-light">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>قائمة العملاء</h2>
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-2"></i>تصدير Excel
                </button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="customersTable" class="table">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>رقم الهاتف</th>
                                    <th>الحالة</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="customersList">
                                <!-- سيتم إضافة العملاء هنا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- إرسال رسائل -->
    <section id="messages" class="py-5">
        <div class="container">
            <h2 class="mb-4">إرسال رسائل للعملاء</h2>
            <div class="card">
                <div class="card-body">
                    <form id="messageForm">
                        <div class="mb-3">
                            <label class="form-label">نوع الرسالة</label>
                            <select class="form-select" id="messageType">
                                <option value="all">جميع العملاء</option>
                                <option value="trial">نسخة تجريبية</option>
                                <option value="basic">نسخة أساسية</option>
                                <option value="pro">نسخة احترافية</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">عنوان الرسالة</label>
                            <input type="text" class="form-control" id="messageSubject" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نص الرسالة</label>
                            <textarea class="form-control" id="messageContent" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>إرسال
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- تحديث رقم الإصدار -->
    <section id="version" class="py-5 bg-light">
        <div class="container">
            <h2 class="mb-4">تحديث رقم الإصدار</h2>
            <div class="card">
                <div class="card-body">
                    <form id="versionForm">
                        <div class="mb-3">
                            <label class="form-label">رقم الإصدار الحالي</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="currentVersion" readonly>
                                <button class="btn btn-secondary" type="button" onclick="copyVersion()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">رقم الإصدار الجديد</label>
                            <input type="text" class="form-control" id="newVersion" required 
                                   pattern="^\d+\.\d+\.\d+$" 
                                   placeholder="مثال: 1.2.3">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">وصف التحديث</label>
                            <textarea class="form-control" id="versionDescription" rows="3" required></textarea>
                        </div>
                        <div id="versionError" class="text-danger mb-3" style="display:none;"></div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>تحديث رقم الإصدار
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- قسم تغيير كلمة المرور -->
    <section id="changePassword" class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header text-center">
                            <h3>تغيير كلمة المرور</h3>
                        </div>
                        <div class="card-body">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">كلمة المرور الحالية</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">كلمة المرور الجديدة</label>
                                    <input type="password" class="form-control" id="newPassword" required minlength="8">
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">تأكيد كلمة المرور الجديدة</label>
                                    <input type="password" class="form-control" id="confirmPassword" required minlength="8">
                                </div>
                                <div id="passwordError" class="text-danger mb-3" style="display:none;"></div>
                                <button type="submit" class="btn btn-primary w-100">تغيير كلمة المرور</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- الأدوات الأخرى -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // التحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const loginTime = localStorage.getItem('loginTime');
            
            // إذا لم يكن المستخدم مسجل الدخول، توجيهه إلى صفحة تسجيل الدخول
            if (!isLoggedIn) {
                window.location.href = 'login.html';
                return;
            }
            
            // التحقق من صلاحية الجلسة (24 ساعة)
            if (loginTime) {
                const loginDate = new Date(loginTime);
                const currentDate = new Date();
                const hoursDiff = (currentDate - loginDate) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    // انتهت صلاحية الجلسة
                    logout();
                    return;
                }
            }
        }

        // تنفيذ التحقق من تسجيل الدخول عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            // تهيئة البيانات التجريبية
            initDemoData();
        });
        
        // تسجيل الخروج
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('loginTime');
            window.location.href = 'login.html';
        }
        
        // تهيئة البيانات التجريبية
        function initDemoData() {
            // بيانات تجريبية للإصدار
            document.getElementById('currentVersion').value = "2.1.0";
            
            // بيانات تجريبية للعملاء
            displayCustomers();
            
            // تحديث الإحصائيات
            updateStats();
        }
        
        // عرض قائمة العملاء
        async function displayCustomers() {
            const tbody = document.getElementById('customersList');
            
            // مسح البيانات الحالية
            tbody.innerHTML = '';
            
            try {
                // جلب بيانات العملاء من Firestore
                const customersRef = firebase.firestore().collection('customers');
                const snapshot = await customersRef.get();
                
                if (snapshot.empty) {
                    console.log('لا يوجد عملاء');
                    // إضافة بيانات تجريبية إذا لم يكن هناك عملاء
                    addDemoCustomers();
                    return;
                }
                
                // إضافة العملاء إلى الجدول
                snapshot.forEach(doc => {
                    const customer = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name || 'غير محدد'}</td>
                        <td>${customer.email || 'غير محدد'}</td>
                        <td>${customer.phone || 'غير محدد'}</td>
                        <td><span class="badge ${customer.status === 'نشط' ? 'bg-success' : 'bg-secondary'}">${customer.status || 'غير نشط'}</span></td>
                        <td>${customer.registrationDate ? (customer.registrationDate.toDate ? customer.registrationDate.toDate().toLocaleDateString() : new Date(customer.registrationDate).toLocaleDateString()) : 'غير محدد'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="sendEmail('${customer.email}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="btn btn-sm btn-info">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // تحديث عدد العملاء في الإحصائيات
                document.getElementById('totalCustomers').textContent = snapshot.size;
                
            } catch (error) {
                console.error("خطأ في جلب بيانات العملاء:", error);
                // إضافة بيانات تجريبية في حالة وجود خطأ
                addDemoCustomers();
            }
        }
        
        // إضافة بيانات تجريبية للعملاء
        async function addDemoCustomers() {
            const tbody = document.getElementById('customersList');
            
            // بيانات تجريبية للعملاء
            const demoCustomers = [
                { name: 'شركة الأمل للتجارة', email: 'info@alamal.com', phone: '0512345678', status: 'نشط', registrationDate: new Date(2023, 11, 15) },
                { name: 'مؤسسة النور للمقاولات', email: 'contact@alnoor.com', phone: '0598765432', status: 'نشط', registrationDate: new Date(2023, 10, 20) },
                { name: 'شركة الصفا للخدمات', email: 'support@alsafa.com', phone: '0555555555', status: 'غير نشط', registrationDate: new Date(2023, 9, 5) },
                { name: 'مجموعة الفارس', email: 'info@alfaris.com', phone: '0501234567', status: 'نشط', registrationDate: new Date(2023, 8, 10) },
                { name: 'شركة المستقبل', email: 'future@company.com', phone: '0567891234', status: 'نشط', registrationDate: new Date(2024, 0, 5) },
                { name: 'مؤسسة الرواد', email: 'alrowad@gmail.com', phone: '0733542164', status: 'نشط', registrationDate: new Date(2024, 1, 15) },
                { name: 'شركة الخليج للتقنية', email: 'gulf@tech.com', phone: '0733542165', status: 'نشط', registrationDate: new Date(2024, 2, 1) },
                { name: 'مؤسسة البناء الحديث', email: 'modern@build.com', phone: '0733542166', status: 'غير نشط', registrationDate: new Date(2023, 7, 20) },
                { name: 'شركة الأفق للاستشارات', email: 'horizon@consult.com', phone: '0733542167', status: 'نشط', registrationDate: new Date(2024, 2, 10) },
                { name: 'مجموعة السلام التجارية', email: 'salam@trade.com', phone: '0733542168', status: 'نشط', registrationDate: new Date() }
            ];
            
            // إضافة العملاء إلى الجدول
            demoCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td><span class="badge ${customer.status === 'نشط' ? 'bg-success' : 'bg-secondary'}">${customer.status}</span></td>
                    <td>${customer.registrationDate.toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="sendEmail('${customer.email}')">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn btn-sm btn-info">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // محاولة إضافة البيانات التجريبية إلى Firestore
            try {
                const customersRef = firebase.firestore().collection('customers');
                
                // التحقق مما إذا كان هناك عملاء بالفعل
                const snapshot = await customersRef.limit(1).get();
                if (!snapshot.empty) {
                    console.log('يوجد بالفعل عملاء في قاعدة البيانات');
                    return;
                }
                
                // إضافة البيانات التجريبية إلى Firestore
                for (const customer of demoCustomers) {
                    await customersRef.add(customer);
                }
                console.log('تمت إضافة البيانات التجريبية بنجاح');
                
            } catch (error) {
                console.error("خطأ في إضافة البيانات التجريبية:", error);
            }
        }
        
        // تحديث الإحصائيات
        async function updateStats() {
            try {
                // جلب بيانات العملاء من Firestore
                const customersRef = firebase.firestore().collection('customers');
                const snapshot = await customersRef.get();
                
                // إجمالي العملاء
                const totalCustomers = snapshot.size;
                document.getElementById('totalCustomers').textContent = totalCustomers;
                
                // العملاء النشطين
                let activeCustomers = 0;
                let newCustomers = 0;
                
                // تاريخ قبل 30 يومًا (للعملاء الجدد)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                snapshot.forEach(doc => {
                    const customer = doc.data();
                    
                    // حساب العملاء النشطين
                    if (customer.status === 'نشط') {
                        activeCustomers++;
                    }
                    
                    // حساب العملاء الجدد (إذا كان هناك حقل تاريخ التسجيل)
                    if (customer.registrationDate) {
                        const regDate = customer.registrationDate.toDate ? customer.registrationDate.toDate() : new Date(customer.registrationDate);
                        if (regDate > thirtyDaysAgo) {
                            newCustomers++;
                        }
                    }
                });
                
                // تحديث الإحصائيات في واجهة المستخدم
                document.getElementById('activeCustomers').textContent = activeCustomers;
                document.getElementById('newCustomers').textContent = newCustomers;
                
                // طلبات معلقة (قيمة تجريبية)
                document.getElementById('pendingRequests').textContent = Math.floor(Math.random() * 10);
                
            } catch (error) {
                console.error("خطأ في تحديث الإحصائيات:", error);
                
                // قيم افتراضية في حالة الخطأ
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('activeCustomers').textContent = '0';
                document.getElementById('newCustomers').textContent = '0';
                document.getElementById('pendingRequests').textContent = '0';
            }
        }
        
        // إرسال رسالة لعميل واحد
        function sendEmail(email) {
            document.getElementById('recipientEmail').value = email;
            const modal = new bootstrap.Modal(document.getElementById('emailModal'));
            modal.show();
        }
        
        // تحديث رقم الإصدار
        document.getElementById('versionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentVersion = document.getElementById('currentVersion').value;
            const newVersion = document.getElementById('newVersion').value;
            const description = document.getElementById('versionDescription').value;
            const errorDiv = document.getElementById('versionError');
            
            // إعادة تعيين رسائل الخطأ
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            
            try {
                // تحديث رقم الإصدار (محاكاة)
                document.getElementById('currentVersion').value = newVersion;
                
                // عرض رسالة نجاح
                alert('تم تحديث رقم الإصدار بنجاح');
                this.reset();
                document.getElementById('currentVersion').value = newVersion;
            } catch (error) {
                console.error('خطأ في تحديث رقم الإصدار:', error);
                errorDiv.textContent = error.message || 'حدث خطأ أثناء تحديث رقم الإصدار';
                errorDiv.style.display = 'block';
            }
        });
        
        // تغيير كلمة المرور
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            // إعادة تعيين رسائل الخطأ
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            
            // التحقق من تطابق كلمات المرور
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'كلمة المرور الجديدة وتأكيدها غير متطابقين';
                errorDiv.style.display = 'block';
                return;
            }
            
            // التحقق من كلمة المرور الحالية
            if (currentPassword !== 'admin123') {
                errorDiv.textContent = 'كلمة المرور الحالية غير صحيحة';
                errorDiv.style.display = 'block';
                return;
            }
            
            // عرض رسالة نجاح
            alert('تم تغيير كلمة المرور بنجاح');
            this.reset();
        });
        
        // إرسال رسائل جماعية
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;
            
            // محاكاة إرسال الرسائل
            alert(`تم إرسال الرسالة بنجاح إلى 132 عميل\nالموضوع: ${subject}`);
            this.reset();
        });
        
        // تصدير إلى Excel
        async function exportToExcel() {
            try {
                // إنشاء جدول بيانات للتصدير
                let csvContent = "الاسم,البريد الإلكتروني,رقم الهاتف,الحالة,تاريخ التسجيل\n";
                
                // جلب بيانات العملاء من Firestore
                const customersRef = firebase.firestore().collection('customers');
                const snapshot = await customersRef.get();
                
                if (snapshot.empty) {
                    alert('لا يوجد بيانات للتصدير');
                    return;
                }
                
                // إضافة بيانات العملاء إلى ملف CSV
                snapshot.forEach(doc => {
                    const customer = doc.data();
                    csvContent += `${customer.name || ''},${customer.email || ''},${customer.phone || ''},${customer.status || ''},${customer.registrationDate ? (customer.registrationDate.toDate ? customer.registrationDate.toDate().toLocaleDateString() : new Date(customer.registrationDate).toLocaleDateString()) : ''}\n`;
                });
                
                // إنشاء رابط تنزيل
                const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'قائمة_العملاء_' + new Date().toLocaleDateString() + '.csv');
                document.body.appendChild(link);
                
                // تنفيذ التنزيل
                link.click();
                document.body.removeChild(link);
                
                alert('تم تصدير بيانات العملاء إلى ملف Excel بنجاح');
            } catch (error) {
                console.error("خطأ في تصدير البيانات:", error);
                alert('حدث خطأ أثناء تصدير البيانات');
            }
        }
        
        // نسخ رقم الإصدار
        function copyVersion() {
            const version = document.getElementById('currentVersion').value;
            navigator.clipboard.writeText(version)
                .then(() => alert('تم نسخ رقم الإصدار: ' + version))
                .catch(err => console.error('خطأ في نسخ النص: ', err));
        }
        
        // إضافة مستمع لزر تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', function() {
            logout();
        });
    </script>
</body>
</html>
